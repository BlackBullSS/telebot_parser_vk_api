# VK-Telegram Spy Bot

## История проекта

Этот проект родился из необходимости автоматизировать мониторинг объявлений о продаже страйкбольного оружия (в частности, GBBR - Gas BlowBack Rifles) в группах ВКонтакте. Ранее поиск подходящих предложений требовал много времени вручную. Целью стало создание Telegram-бота, который отслеживает посты в указанных группах, находит объявления, соответствующие заданным критериям (наличие определённых моделей/брендов и упоминание "газового" привода), и отправляет уведомления в соответствующие темы супергруппы Telegram.

## Идея проекта

Создать автоматизированный инструмент для:

1.  **Мониторинга** постов в заданных группах ВКонтакте.
2.  **Фильтрации** постов по сложным критериям (модели/бренды, ключевые слова, контекст).
3.  **Извлечения** структурированной информации из подходящих объявлений (Бренд, Цена, Состояние/Описание, Город).
4.  **Отправки** отфильтрованных объявлений в Telegram-супергруппу в соответствующие темы ("Поиск GBB" и "Барахолки").
5.  **Обучения** собственной ML-модели для извлечения информации, с целью **отказа от стороннего API** (DeepSeek) и **самостоятельного анализа текста**.

## Что реализовано

*   **Парсинг ВКонтакте:** Скрипт может получать посты из публичных групп ВКонтакте с использованием VK API и сервисного токена.
*   **Сложные правила фильтрации:** Реализована логика поиска постов, содержащих:
    *   Точные названия моделей/брендов (например, "Tokyo Marui MWS") в любом порядке слов.
    *   Общие упоминания моделей/брендов (например, "M4", "AK", "VFC"), **но только при наличии** ключевых слов, связанных с газовым приводом ("GBBR", "ГББР", "Газовая винтовка", "Gas Blowback").
*   **Отправка в Telegram:**
    *   Подходящие посты отправляются в тему "Поиск GBB".
    *   Неподходящие посты отправляются в тему "Барахолки".
    *   Используется `pyTelegramBotAPI`.
*   **Извлечение информации через DeepSeek:** Текст объявления отправляется в DeepSeek API, который возвращает структурированные данные (Бренд, Цена, Состояние, Город).
*   **Логирование и предотвращение дубликатов:** Все обработанные посты (и подходящие, и нет) логируются в локальную базу данных SQLite (`parsed_posts.db`), чтобы избежать повторной отправки.
*   **Обучение ML-модели (T5):**
    *   Сырые и обработанные (DeepSeek) данные сохраняются в базе данных.
    *   Реализован процесс дообучения модели `T5-small` на парах `(сырой_текст, вывод_DeepSeek)` (в транслите через `unidecode`).
    *   Модель обучается генерировать структурированный ответ.
    *   Используется `transformers`, `torch`, `accelerate`.
    *   Вывод модели сохраняется в базе данных.
*   **Оценка качества (BLEU):** Реализована функция `evaluate`, которая вычисляет BLEU-оценку между выводом ML-модели и эталонным выводом DeepSeek.
*   **Использование GPU:** Обучение и инференс T5 модели могут использовать GPU (если доступен и установлен PyTorch с CUDA).
*   **Транслитерация (`unidecode`):** Вся обработка текста (ввод, вывод DeepSeek, обучение/инференс модели) происходит на **транслитерированном** (в ASCII) тексте с помощью `unidecode`, чтобы обойти проблемы с генерацией кириллицы моделью T5.
*   **Обработка ошибок:** В коде реализована обработка сетевых ошибок, ошибок API, ошибок при работе с базой данных и т.д. с логированием.
*   **Логирование:** Подробное логирование в файл (`logs/app.log`) и в консоль.
*   **Повторные попытки:** При ошибках отправки в Telegram или получения данных из ВК делается несколько попыток.

## Что планируется

*   **Достижение точности ML-модели > 85%:** Настроить обучение и архитектуру модели так, чтобы её точность (BLEU или другая метрика) превышала 85% по сравнению с DeepSeek.
*   **Переключение на ML-модель:** После достижения порога точности, переключить логику отправки в Telegram на использование вывода ML-модели вместо DeepSeek.
*   **Улучшение качества извлечения:** Рассмотреть использование более сложных метрик оценки (например, семантическое сходство) и дообучение на корректировках ошибок.
*   **Расширение функционала:** Возможность настройки правил фильтрации через файл/базу данных.
*   **Мониторинг других платформ:** Возможность интеграции с другими досками объявлений (например, Avito).
*   **Улучшение интерфейса бота:** Возможность управления подписками или фильтрами через команды бота.

## Структура проекта
vk-telegram-spy-bot/
│
├── logs/
│ └── app.log # Файл с логами
├── models/
│ └── t5_custom/ # Обученная модель T5 (если существует)
├── .env # Файл с токенами и API-ключами (не в репозитории!)
├── main.py # Основной скрипт
├── vk_parser.py # Модуль для работы с VK API
├── telegram_bot.py # Модуль для работы с Telegram Bot API
├── deepseek_processor.py # Модуль для взаимодействия с DeepSeek
├── ml_processor.py # Модуль для ML модели и обучения
├── db.py # Модуль для логирования (SQLite)
├── filters.py # Модуль с логикой фильтрации
├── keywords.txt # Файл с ключевыми словами
├── view_db.py # Вспомогательный скрипт для просмотра БД
├── test_deepseek_translit.py # Вспомогательный скрипт для теста DeepSeek
└── requirements.txt # Зависимости
└── README.md # Этот файл


## Установка и запуск

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/ваш-username/vk-telegram-spy-bot.git
    cd vk-telegram-spy-bot
    ```
2.  **Создайте виртуальное окружение (рекомендуется):**
    ```bash
    python -m venv venv
    source venv/bin/activate  # Linux/Mac
    # или
    venv\Scripts\activate     # Windows
    ```
3.  **Установите зависимости:**
    ```bash
    pip install -r requirements.txt
    ```
4.  **Установите PyTorch с поддержкой CUDA (если GPU доступен):**
    *   Посетите [https://pytorch.org/get-started/locally/](https://pytorch.org/get-started/locally/)
    *   Выберите вашу конфигурацию (например, Stable, Windows, Pip, Python 3.x, CUDA 11.8/12.1)
    *   Выполните предложенную команду.
5.  **Создайте файл `.env`** в корне проекта и **укажите токены/ключи:**
    ```env
    TELEGRAM_BOT_TOKEN=ваш_токен_бота
    VK_SERVICE_TOKEN=ваш_сервисный_токен_вк
    DEEPSEEK_API_KEY=ваш_api_ключ_deepseek
    ```
6.  **Запустите проект:**
    ```bash
    python main.py
    ```

## Важно

*   **Файл `.env` должен быть в `.gitignore`** (уже добавлен в шаблон `.gitignore` при создании репозитория GitHub), чтобы токены не попали в публичный доступ.
*   **Токен VK Service Token** должен быть получен от приложения ВКонтакте с правами доступа к `wall`.
*   **Токен Telegram Bot Token** создаётся через `@BotFather`.
*   **API Key DeepSeek** требуется для использования их API.
*   **Токен должен иметь права** на отправку сообщений в указанную супергруппу Telegram и в нужные темы.
*   **GPU (NVIDIA)** рекомендуется для обучения модели T5.
