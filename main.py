import os
import time
import logging
import requests  # <-- –î–æ–±–∞–≤–∏—Ç—å
from datetime import datetime
from dotenv import load_dotenv
import re  # <-- –î–æ–±–∞–≤–∏—Ç—å –¥–ª—è –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏

# --- –ò–º–ø–æ—Ä—Ç—ã ---
from db import (
    init_db,
    is_post_processed,
    mark_post_as_processed,
    log_raw_post,
    log_processed_post,
    log_ml_processed_post,
)
from vk_parser import get_wall_posts, extract_text_from_post
from telegram_bot import send_post_to_chat
from deepseek_processor import process_with_deepseek
from filters import load_keywords_from_file, contains_keyword
import filters

# --- –ù–û–í–´–ô –∏–º–ø–æ—Ä—Ç ---
from ml_processor import MLProcessor
from unidecode import unidecode  # <-- –î–æ–±–∞–≤–∏—Ç—å

# --- /–ù–û–í–´–ô –∏–º–ø–æ—Ä—Ç ---

# --- –ö—ç—à –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ DeepSeek (—Ö—Ä–∞–Ω–∏—Ç —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è ML) ---
processed_cache = {}
# --- /–ö—ç—à ---

# --- –°—á—ë—Ç—á–∏–∫ —Ü–∏–∫–ª–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ---
cycle_count = 0
# --- /–°—á—ë—Ç—á–∏–∫ ---


def preprocess_text(text):
    """
    –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞: –∑–∞–º–µ–Ω–∞ \n, \t –∏ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–±–µ–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –æ–¥–∏–Ω –ø—Ä–æ–±–µ–ª,
    —É–¥–∞–ª–µ–Ω–∏–µ —ç–º–æ–¥–∑–∏ –∏ –ø—Ä–æ—á–∏—Ö —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤.
    """
    # –ó–∞–º–µ–Ω—è–µ–º \n, \t, \r –∏ –¥—Ä—É–≥–∏–µ –ø—Ä–æ–±–µ–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –Ω–∞ –æ–¥–∏–Ω –ø—Ä–æ–±–µ–ª
    text = re.sub(r"\s+", " ", text)
    # –£–¥–∞–ª—è–µ–º —ç–º–æ–¥–∑–∏
    text = re.sub(
        r"[\U0001F600-\U0001F64F\U0001F300-\U0001F5FF\U0001F680-\U0001F6FF\U0001F1E0-\U0001F1FF\U00002600-\U000027BF\U0001F900-\U0001F9FF\U0001F018-\U0001F270]+",
        "",
        text,
    )
    # –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
    text = text.strip()
    return text


# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è ---
def setup_logging():
    # –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É logs, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    os.makedirs("logs", exist_ok=True)

    # –§–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤
    log_format = logging.Formatter(
        fmt="%(asctime)s - %(levelname)s - %(message)s", datefmt="%Y-%m-%d %H:%M:%S"
    )

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–∞–π–ª–∞
    file_handler = logging.FileHandler("logs/app.log", encoding="utf-8")
    file_handler.setLevel(logging.DEBUG)
    file_handler.setFormatter(log_format)

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏
    console_handler = logging.StreamHandler()
    console_handler.setLevel(logging.INFO)  # INFO –∏ –≤—ã—à–µ –≤ –∫–æ–Ω—Å–æ–ª—å
    console_handler.setFormatter(log_format)

    # –ü–æ–ª—É—á–∞–µ–º –∫–æ—Ä–Ω–µ–≤–æ–π –ª–æ–≥–≥–µ—Ä
    logger = logging.getLogger()
    logger.setLevel(logging.DEBUG)  # DEBUG –∏ –≤—ã—à–µ –¥–ª—è –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    logger.addHandler(file_handler)
    logger.addHandler(console_handler)


# --- /–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è ---

load_dotenv()

TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
VK_SERVICE_TOKEN = os.getenv("VK_SERVICE_TOKEN")
CHAT_ID = -1002995030740  # –ù–∞–ø—Ä–∏–º–µ—Ä, -1001234567890

GROUPS_TO_MONITOR = [
    -191504008,  # –°—Ç—Ä–∞–π–∫–±–æ–ª—å–Ω–∞—è –±–∞—Ä–∞—Ö–æ–ª–∫–∞. –ú–æ—Å–∫–≤–∞ –∏ –ú–°–ö –æ–±–ª–∞—Å—Ç—å
    -87969557,
    -56893805,
    -76629546,
    -110771825,
    -148842595,
    -80891598,
    -11571122,
    # –î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–≥–∏–µ ID –≥—Ä—É–ø–ø —Å—é–¥–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
]

# --- –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –≤ –º–æ–¥—É–ª–µ filters ---
load_keywords_from_file("keywords.txt")
# –¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ SPECIFIC_MODELS, GENERAL_MODELS_BRANDS, GAS_KEYWORDS –≤ filters –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
# --- /–ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ ---

# --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º MLProcessor ---
ml_processor = MLProcessor()
# --- /–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º MLProcessor ---


def main_loop():
    global cycle_count  # <-- –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è
    logging.info("–ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –±–æ—Ç–∞.")
    init_db()
    while True:
        cycle_count += 1
        logging.info(f"--- –ù–∞—á–∞–ª–æ —Ü–∏–∫–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ #{cycle_count} ---")
        for group_id in GROUPS_TO_MONITOR:
            logging.info(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä—É–ø–ø—ã: {group_id}")
            try:
                posts = get_wall_posts(group_id, VK_SERVICE_TOKEN)
            except Exception as e:
                logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ—Å—Ç–æ–≤ –∏–∑ –≥—Ä—É–ø–ø—ã {group_id}: {e}")
                # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –¥—Ä—É–≥–æ–π –≥—Ä—É–ø–ø–æ–π
                continue

            if not posts:
                logging.warning(
                    f"  - –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ—Å—Ç—ã –¥–ª—è –≥—Ä—É–ø–ø—ã {group_id} –∏–ª–∏ –ø–æ—Å—Ç–æ–≤ –Ω–µ—Ç."
                )
                continue

            for post in posts:
                post_id = f"{group_id}_{post['id']}"
                post_url = f"https://vk.com/wall{post_id}"
                logging.debug(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Å—Ç–∞: {post_id}")

                # --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç (–¥–ª—è –≤—Å–µ—Ö –ø–æ—Å—Ç–æ–≤) ---
                try:
                    if is_post_processed(post_id):
                        logging.debug(f"  - –ü–æ—Å—Ç {post_id} —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º.")
                        continue
                except Exception as e:
                    logging.error(
                        f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –ø–æ—Å—Ç–∞ {post_id}: {e}"
                    )
                    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç –ø–æ—Å—Ç –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É
                    continue

                try:
                    text = extract_text_from_post(post)
                except Exception as e:
                    logging.error(
                        f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ –∏–∑ –ø–æ—Å—Ç–∞ {post_id}: {e}"
                    )
                    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç –ø–æ—Å—Ç
                    continue

                # --- –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ ---
                processed_text_for_storage = preprocess_text(text)
                text_translit_for_deepseek = unidecode(processed_text_for_storage)
                # --- /–ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ ---

                # --- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ "—Å—ã—Ä–æ–≥–æ" –ø–æ—Å—Ç–∞ (–æ—Ä–∏–≥–∏–Ω–∞–ª –∏ —Ç—Ä–∞–Ω—Å–ª–∏—Ç) ---
                raw_post_db_id = log_raw_post(
                    post_id, group_id, text, post["date"], post_url
                )
                if raw_post_db_id is None:
                    logging.error(
                        f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å—ã—Ä–æ–π –ø–æ—Å—Ç {post_id}. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º."
                    )
                    continue
                # --- /–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ "—Å—ã—Ä–æ–≥–æ" –ø–æ—Å—Ç–∞ ---

                # --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (–Ω–∞ –û–†–ò–ì–ò–ù–ê–õ–¨–ù–û–ú —Ç–µ–∫—Å—Ç–µ) ---
                try:
                    is_suitable = contains_keyword(text)
                except Exception as e:
                    logging.error(
                        f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –≤ –ø–æ—Å—Ç–µ {post_id}: {e}"
                    )
                    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç –ø–æ—Å—Ç
                    continue

                # --- –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ DeepSeek (–¥–ª—è –≤—Å–µ—Ö –ø–æ—Å—Ç–æ–≤) ---
                processed_text = None
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à (—Ç–µ–ø–µ—Ä—å –∫—ç—à —Ö—Ä–∞–Ω–∏—Ç –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô —Ä–µ–∑—É–ª—å—Ç–∞—Ç DeepSeek, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∏–∑ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–∞)
                cache_key = f"{post_id}_deepseek"
                if cache_key in processed_cache:
                    processed_text = processed_cache[cache_key]
                    logging.debug(
                        f"  - –†–µ–∑—É–ª—å—Ç–∞—Ç DeepSeek –¥–ª—è {post_id} –≤–∑—è—Ç –∏–∑ –∫—ç—à–∞ (–æ—Ä–∏–≥–∏–Ω–∞–ª)."
                    )
                else:
                    try:
                        # --- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ DeepSeek ---
                        logging.debug(
                            f"  - –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ DeepSeek —Ç—Ä–∞–Ω—Å–ª–∏—Ç: {text_translit_for_deepseek}"
                        )
                        processed_text_from_deepseek = process_with_deepseek(
                            text_translit_for_deepseek
                        )  # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω—Å–ª–∏—Ç
                        # --- /–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ DeepSeek ---

                        if (
                            not processed_text_from_deepseek
                            or "–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞."
                            in processed_text_from_deepseek
                        ):
                            logging.warning(
                                f"  - DeepSeek –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É –¥–ª—è –ø–æ—Å—Ç–∞ {post_id}. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º."
                            )
                            # –í–∞–∂–Ω–æ: –¥–∞–∂–µ –µ—Å–ª–∏ DeepSeek –Ω–µ —Å–ø—Ä–∞–≤–∏–ª—Å—è, –º—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–º–µ—á–∞–µ–º –ø–æ—Å—Ç –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π,
                            # —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å—Ç—Ä—è—Ç—å –Ω–∞ –Ω—ë–º –≤–µ—á–Ω–æ.
                            try:
                                mark_post_as_processed(post_id)
                                logging.debug(
                                    f"  - –ü–æ—Å—Ç {post_id} (–æ—à–∏–±–∫–∞ DeepSeek) –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π."
                                )
                            except Exception as e:
                                logging.error(
                                    f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –ø–æ—Å—Ç–∞ –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ {post_id}: {e}"
                                )
                            continue  # –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ DeepSeek –Ω–µ —Å–ø—Ä–∞–≤–∏–ª—Å—è

                        # --- –û–±—Ä–∞—Ç–Ω–æ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä—É–µ–º –û–¢–í–ï–¢ DEEPSEEK (–¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏) ---
                        # –í–ê–ñ–ù–û: –ú—ã —Ö–æ—Ç–∏–º —Ö—Ä–∞–Ω–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å "—á–∏—Ç–∞–µ–º—ã–π" —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
                        # unidecode –Ω–µ –¥–µ–ª–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω—É—é —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—é. –ú—ã –Ω–µ –º–æ–∂–µ–º "–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" –∫–∏—Ä–∏–ª–ª–∏—Ü—É –∏–∑ ASCII.
                        # –ü–æ—ç—Ç–æ–º—É, –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏, –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –û–¢–í–ï–¢ DeepSeek (–≤ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ).
                        processed_text = processed_text_from_deepseek  # –≠—Ç–æ —É–∂–µ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
                        logging.debug(
                            f"  - –û—Ç–≤–µ—Ç DeepSeek (–≤ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ): {processed_text}"
                        )
                        # --- /–û–±—Ä–∞—Ç–Ω–æ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä—É–µ–º –û–¢–í–ï–¢ DEEPSEEK ---

                        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô (–≤ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ) —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫—ç—à
                        processed_cache[cache_key] = processed_text
                        logging.debug(
                            f"  - –†–µ–∑—É–ª—å—Ç–∞—Ç DeepSeek –¥–ª—è {post_id} —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –∫—ç—à (—Ç—Ä–∞–Ω—Å–ª–∏—Ç)."
                        )
                        # –õ–æ–≥–∏—Ä—É–µ–º –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô (–≤ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ) —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –±–∞–∑—É
                        log_processed_post(raw_post_db_id, processed_text)
                    except Exception as e:
                        logging.error(
                            f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ DeepSeek –¥–ª—è –ø–æ—Å—Ç–∞ {post_id}: {e}"
                        )
                        # –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ, –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π, —á—Ç–æ–±—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –ø–æ–ø—ã—Ç–∫—É.
                        try:
                            mark_post_as_processed(post_id)
                            logging.debug(
                                f"  - –ü–æ—Å—Ç {post_id} (–æ—à–∏–±–∫–∞ DeepSeek) –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π."
                            )
                        except Exception as e_log:
                            logging.error(
                                f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –ø–æ—Å—Ç–∞ –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ {post_id}: {e_log}"
                            )
                        continue  # –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

                # --- –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ ML –º–æ–¥–µ–ª—å (–¥–ª—è –≤—Å–µ—Ö –ø–æ—Å—Ç–æ–≤, –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –æ–±—É—á–µ–Ω–∞) ---
                ml_processed_text = None
                if ml_processor.is_trained:
                    try:
                        # –ü–æ–¥–∞–µ–º –¢–†–ê–ù–°–õ–ò–¢–ï–†–ò–†–û–í–ê–ù–ù–´–ô —Ç–µ–∫—Å—Ç (–Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –º–æ–¥–µ–ª—å –æ–±—É—á–µ–Ω–∞)
                        text_for_ml = unidecode(
                            processed_text_for_storage
                        )  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ, —á—Ç–æ –∏ –¥–ª—è DeepSeek
                        ml_processed_text_translit = ml_processor.predict(text_for_ml)
                        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô (–≤ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ) —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–¥–µ–ª–∏
                        ml_processed_text = ml_processed_text_translit
                        # –õ–æ–≥–∏—Ä—É–µ–º –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô (–≤ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ) —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–¥–µ–ª–∏ –≤ –±–∞–∑—É (–∏ —Ç—Ä–∞–Ω—Å–ª–∏—Ç –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)
                        log_ml_processed_post(raw_post_db_id, ml_processed_text)
                        logging.debug(f"  - ML –º–æ–¥–µ–ª—å –æ–±—Ä–∞–±–æ—Ç–∞–ª–∞ –ø–æ—Å—Ç {post_id}.")
                    except Exception as e:
                        logging.error(
                            f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ ML –º–æ–¥–µ–ª—å –¥–ª—è –ø–æ—Å—Ç–∞ {post_id}: {e}"
                        )
                        # –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º DeepSeek –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                        ml_processed_text = None
                else:
                    logging.debug(
                        f"  - ML –º–æ–¥–µ–ª—å –Ω–µ –æ–±—É—á–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–ª—è –ø–æ—Å—Ç–∞ {post_id}."
                    )

                # --- –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram (–∏—Å–ø–æ–ª—å–∑—É–µ–º DeepSeek, –ø–æ–∫–∞ ML –Ω–µ –≥–æ—Ç–æ–≤) ---
                # –í –±—É–¥—É—â–µ–º, –µ—Å–ª–∏ —Ç–æ—á–Ω–æ—Å—Ç—å ML > 85%, –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ml_processed_text
                text_to_send = (
                    processed_text  # –ü–æ–∫–∞ —á—Ç–æ –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º DeepSeek (–≤ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ)
                )

                if not is_suitable:
                    logging.info(
                        f"  - –ù–µ–ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–æ—Å—Ç –Ω–∞–π–¥–µ–Ω: {post_id}. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ —Ç–µ–º—É '–ë–∞—Ä–∞—Ö–æ–ª–∫–∏'."
                    )
                    try:
                        send_post_to_chat(
                            CHAT_ID, post_url, text_to_send, is_suitable=False
                        )
                        logging.info(
                            f"  - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–µ–º –ø–æ—Å—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Ç–µ–º—É '–ë–∞—Ä–∞—Ö–æ–ª–∫–∏' –¥–ª—è {post_id}."
                        )
                    except (
                        requests.exceptions.ReadTimeout,
                        requests.exceptions.RequestException,
                    ) as e:
                        # –û—à–∏–±–∫–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Å–µ—Ç—å—é, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ –≤ telegram_bot.py
                        logging.error(
                            f"–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ù–ï–ü–û–î–•–û–î–Ø–©–ï–ì–û –ø–æ—Å—Ç–∞ –≤ Telegram –¥–ª—è {post_id}: {e}"
                        )
                        # –í–∞–∂–Ω–æ: –Ω–µ –ø–æ–º–µ—á–∞–µ–º –ø–æ—Å—Ç –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
                        # –ü–æ–≤—Ç–æ—Ä–∏–º –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ, –∫–æ–≥–¥–∞ —Ü–∏–∫–ª –¥–æ–π–¥—ë—Ç –¥–æ —ç—Ç–æ–≥–æ –ø–æ—Å—Ç–∞ —Å–Ω–æ–≤–∞
                        # –†–µ–∑—É–ª—å—Ç–∞—Ç —É–∂–µ –≤ –∫—ç—à–µ, —Ç–∞–∫ —á—Ç–æ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ DeepSeek –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –Ω–µ –±—É–¥–µ—Ç.
                        continue  # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –ø–æ—Å—Ç—É
                    except Exception as e:
                        # –õ—é–±–∞—è –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ (–≤–∫–ª—é—á–∞—è ApiException)
                        logging.error(
                            f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ù–ï–ü–û–î–•–û–î–Ø–©–ï–ì–û –ø–æ—Å—Ç–∞ –≤ Telegram –¥–ª—è {post_id}: {e}"
                        )
                        # –í–∞–∂–Ω–æ: –Ω–µ –ø–æ–º–µ—á–∞–µ–º –ø–æ—Å—Ç –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
                        # –ü–æ–≤—Ç–æ—Ä–∏–º –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ, –∫–æ–≥–¥–∞ —Ü–∏–∫–ª –¥–æ–π–¥—ë—Ç –¥–æ —ç—Ç–æ–≥–æ –ø–æ—Å—Ç–∞ —Å–Ω–æ–≤–∞
                        # –†–µ–∑—É–ª—å—Ç–∞—Ç —É–∂–µ –≤ –∫—ç—à–µ, —Ç–∞–∫ —á—Ç–æ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ DeepSeek –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –Ω–µ –±—É–¥–µ—Ç.
                        continue  # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –ø–æ—Å—Ç—É
                else:  # –ü–æ–¥—Ö–æ–¥—è—â–∏–π –ø–æ—Å—Ç
                    logging.info(f"  - –ù–∞–π–¥–µ–Ω –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–æ—Å—Ç: {post_id}")
                    try:
                        send_post_to_chat(
                            CHAT_ID, post_url, text_to_send, is_suitable=True
                        )
                        logging.info(
                            f"  - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Ç–µ–º—É '–ü–æ–∏—Å–∫ GBB' –¥–ª—è –ø–æ—Å—Ç–∞ {post_id}."
                        )
                    except (
                        requests.exceptions.ReadTimeout,
                        requests.exceptions.RequestException,
                    ) as e:
                        # –û—à–∏–±–∫–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Å–µ—Ç—å—é, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ –≤ telegram_bot.py
                        logging.error(
                            f"–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ü–û–î–•–û–î–Ø–©–ï–ì–û –ø–æ—Å—Ç–∞ –≤ Telegram –¥–ª—è {post_id}: {e}"
                        )
                        # –í–∞–∂–Ω–æ: –Ω–µ –ø–æ–º–µ—á–∞–µ–º –ø–æ—Å—Ç –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
                        # –ü–æ–≤—Ç–æ—Ä–∏–º –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ, –∫–æ–≥–¥–∞ —Ü–∏–∫–ª –¥–æ–π–¥—ë—Ç –¥–æ —ç—Ç–æ–≥–æ –ø–æ—Å—Ç–∞ —Å–Ω–æ–≤–∞
                        # –†–µ–∑—É–ª—å—Ç–∞—Ç —É–∂–µ –≤ –∫—ç—à–µ, —Ç–∞–∫ —á—Ç–æ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ DeepSeek –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –Ω–µ –±—É–¥–µ—Ç.
                        continue  # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –ø–æ—Å—Ç—É
                    except Exception as e:
                        # –õ—é–±–∞—è –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ (–≤–∫–ª—é—á–∞—è ApiException)
                        logging.error(
                            f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ü–û–î–•–û–î–Ø–©–ï–ì–û –ø–æ—Å—Ç–∞ –≤ Telegram –¥–ª—è {post_id}: {e}"
                        )
                        # –í–∞–∂–Ω–æ: –Ω–µ –ø–æ–º–µ—á–∞–µ–º –ø–æ—Å—Ç –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
                        # –ü–æ–≤—Ç–æ—Ä–∏–º –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ, –∫–æ–≥–¥–∞ —Ü–∏–∫–ª –¥–æ–π–¥—ë—Ç –¥–æ —ç—Ç–æ–≥–æ –ø–æ—Å—Ç–∞ —Å–Ω–æ–≤–∞
                        # –†–µ–∑—É–ª—å—Ç–∞—Ç —É–∂–µ –≤ –∫—ç—à–µ, —Ç–∞–∫ —á—Ç–æ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ DeepSeek –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –Ω–µ –±—É–¥–µ—Ç.
                        continue  # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –ø–æ—Å—Ç—É

                # --- –û—Ç–º–µ—Ç–∫–∞ –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏) ---
                try:
                    mark_post_as_processed(post_id)
                    logging.debug(f"  - –ü–æ—Å—Ç {post_id} –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π.")
                    # –£–¥–∞–ª—è–µ–º –∏–∑ –∫—ç—à–∞, —á—Ç–æ–±—ã –Ω–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å –ø–∞–º—è—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
                    processed_cache.pop(cache_key, None)
                except Exception as e:
                    logging.error(
                        f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –ø–æ—Å—Ç–∞ –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ {post_id}: {e}"
                    )
                    # –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ, —Ç.–∫. –ø–æ—Å—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å–Ω–æ–≤–∞.
                    # –ù–æ –º—ã –Ω–µ –º–æ–∂–µ–º –Ω–∏—á–µ–≥–æ —Å–¥–µ–ª–∞—Ç—å, –∫—Ä–æ–º–µ –∫–∞–∫ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å.

        logging.info(f"--- –ö–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ #{cycle_count}. –ü–∞—É–∑–∞... ---")

        # --- –û–±—É—á–µ–Ω–∏–µ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ ---
        # –û–±—É—á–∞–µ–º –º–æ–¥–µ–ª—å –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ü–∏–∫–ª–∞ (–∏–ª–∏ —á–µ—Ä–µ–∑ N —Ü–∏–∫–ª–æ–≤)
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é 3-—é –ø–∞—É–∑—É
        try:
            logging.info("–ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏...")
            ml_processor.train()
            if cycle_count % 3 == 0:
                logging.info(f"--- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –ø–æ—Å–ª–µ —Ü–∏–∫–ª–∞ #{cycle_count} ---")
                accuracy = ml_processor.evaluate()
                logging.info(f"–¢–æ—á–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ (BLEU): {accuracy:.2%}")
                if accuracy > 0.85:
                    logging.info(
                        "üéâ –¢–æ—á–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ –ø—Ä–µ–≤—ã—Å–∏–ª–∞ 85%! –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
                    )
                    print("!!! –í–ù–ò–ú–ê–ù–ò–ï: –¢–æ—á–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ –ø—Ä–µ–≤—ã—Å–∏–ª–∞ 85% !!!")
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—É—á–µ–Ω–∏–∏ –∏–ª–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –º–æ–¥–µ–ª–∏: {e}")

        # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10 –º–∏–Ω—É—Ç)
        time.sleep(600)


if __name__ == "__main__":
    setup_logging()  # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    main_loop()
